<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CFS Label Generator ‚Äî Component West Inc.</title>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #242736;
    --border: #2e3245;
    --text: #e8e9ed;
    --text-dim: #8b8fa3;
    --accent: #f59e0b;
    --accent-dim: rgba(245,158,11,0.12);
    --danger: #ef4444;
    --success: #22c55e;
    --radius: 8px;
    --font: 'DM Sans', sans-serif;
    --mono: 'JetBrains Mono', monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; }

  /* ‚îÄ‚îÄ LOCK SCREEN ‚îÄ‚îÄ */
  #lockScreen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  #lockBox { background: var(--surface); padding: 40px; border-radius: var(--radius); border: 1px solid var(--border); text-align: center; width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
  #lockInput { width: 100%; padding: 12px; margin: 16px 0; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; text-align: center; font-size: 24px; letter-spacing: 8px; font-family: var(--mono); outline: none; transition: border-color 0.2s; }
  #lockInput:focus { border-color: var(--accent); }
  
  /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
  .app-shell { max-width: 1200px; margin: 0 auto; padding: 24px 20px 80px; display: none; }
  
  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .app-header { display: flex; align-items: center; gap: 16px; padding-bottom: 24px; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
  .logo-box { width: 42px; height: 42px; background: var(--accent); border-radius: 6px; display: grid; place-items: center; color: #000; font-weight: 800; font-size: 18px; }
  
  /* ‚îÄ‚îÄ STEPS ‚îÄ‚îÄ */
  .steps-bar { display: flex; gap: 4px; margin-bottom: 24px; background: var(--surface); border-radius: var(--radius); padding: 4px; border: 1px solid var(--border); }
  .step-pill { flex: 1; padding: 10px; border-radius: 6px; font-size: 13px; font-weight: 600; text-align: center; color: var(--text-dim); cursor: pointer; transition: 0.2s; }
  .step-pill.active { background: var(--accent); color: #000; }
  
  /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
  .panel { display: none; animation: fadeUp 0.3s ease; }
  .panel.visible { display: block; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
  .card-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 12px; }
  
  /* ‚îÄ‚îÄ INPUTS & BUTTONS ‚îÄ‚îÄ */
  input, select, textarea { font-family: var(--font); font-size: 14px; padding: 10px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); width: 100%; outline: none; transition: 0.2s; }
  input:focus, textarea:focus { border-color: var(--accent); }
  
  .btn { font-size: 14px; font-weight: 600; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-primary:hover { background: #fbbf24; transform: translateY(-1px); }
  .btn-primary:disabled { opacity: 0.5; cursor: wait; transform: none; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--text-dim); }
  .btn-row { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
  .btn-sm { padding: 6px 12px; font-size: 12px; }

  /* ‚îÄ‚îÄ PASTE ZONE ‚îÄ‚îÄ */
  .paste-zone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 40px 20px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
  .paste-zone:hover, .paste-zone:focus { border-color: var(--accent); background: var(--accent-dim); outline: none; }
  .preview-wrap { display: none; text-align: center; }
  .preview-img { max-width: 100%; max-height: 300px; object-fit: contain; border-radius: 4px; border: 1px solid var(--border); margin-bottom: 12px; }
  
  /* ‚îÄ‚îÄ GRID TABLE ‚îÄ‚îÄ */
  .quick-entry-wrap { display: flex; gap: 20px; flex-wrap: wrap; }
  .col-left { flex: 1; min-width: 300px; }
  .col-right { flex: 1.5; min-width: 300px; }
  
  .ss-table { width: 100%; border-collapse: collapse; font-family: var(--mono); font-size: 13px; }
  .ss-table th { text-align: left; color: var(--text-dim); padding: 8px; border-bottom: 1px solid var(--border); font-size: 11px; text-transform: uppercase; }
  .ss-table td { border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); padding: 0; }
  .ss-cell-input { border: none; background: transparent; padding: 8px; width: 100%; height: 100%; font-family: inherit; color: var(--text); border-radius: 0; outline: none; }
  .ss-cell-input:focus { background: rgba(245,158,11,0.1); }
  
  /* ‚îÄ‚îÄ LOADING BAR ‚îÄ‚îÄ */
  .ocr-bar { height: 6px; background: var(--surface2); margin-top: 15px; border-radius: 3px; overflow: hidden; display: none; }
  .ocr-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.4s ease; }
  
  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--surface); border: 1px solid var(--accent); color: var(--text); padding: 12px 24px; border-radius: 50px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 9999; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  
  #qr-scratch { position: absolute; left: -9999px; }
</style>
</head>
<body>

<div id="lockScreen">
  <div id="lockBox">
    <div style="font-size:32px;margin-bottom:12px;">üîí</div>
    <h3>Restricted Access</h3>
    <p style="color:var(--text-dim);font-size:13px;margin:8px 0 16px;">Enter Team Passcode</p>
    <input type="password" id="lockInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" onkeyup="checkPass(this)">
    <div id="lockMsg" style="font-size:12px;color:var(--danger);height:16px;margin-top:8px;"></div>
  </div>
</div>

<div class="app-shell" id="appShell">
  <div class="app-header">
    <div class="logo-box">CW</div>
    <div>
      <h1 style="font-size:18px;font-weight:700;">CFS Label Generator</h1>
      <p style="color:var(--text-dim);font-size:12px;">West Inc. ‚Ä¢ Static Client ‚Ä¢ v2.0</p>
    </div>
  </div>

  <div class="steps-bar">
    <div class="step-pill active" data-step="1" onclick="goStep(1)">1. Project Info</div>
    <div class="step-pill" data-step="2" onclick="goStep(2)">2. Input Data</div>
    <div class="step-pill" data-step="3" onclick="goStep(3)">3. Review</div>
    <div class="step-pill" data-step="4" onclick="goStep(4)">4. PDF</div>
  </div>

  <div class="panel visible" id="panel-1">
    <div class="card" style="max-width:600px;margin:0 auto;">
      <div class="card-label">Select Project</div>
      <select id="projectSelect" style="margin-bottom:16px;"><option value="">‚Äî Select ‚Äî</option></select>
      
      <div class="card-label">Or Create New</div>
      <div style="display:flex;gap:8px;">
        <input type="text" id="newProjectInput" placeholder="Project Name (e.g. UNLV - Hallway)">
        <button class="btn btn-secondary" onclick="addProject()">Add</button>
      </div>
    </div>
    <div class="btn-row" style="justify-content:center;">
      <button class="btn btn-primary" onclick="goStep(2)" style="width:200px;">Start Labeling ‚Üí</button>
    </div>
  </div>

  <div class="panel" id="panel-2">
    <div class="quick-entry-wrap">
      
      <div class="col-left">
        <div class="card">
          <div class="card-label">1. Panel ID</div>
          <input type="text" id="panelId" placeholder="e.g. P104" style="font-size:18px;font-weight:700;color:var(--accent);letter-spacing:1px;margin-bottom:20px;">
          
          <div class="card-label">2. Input Source</div>
          
          <div class="paste-zone" id="pasteZone" tabindex="0">
            <div id="pastePrompt">
              <span style="font-size:28px;">üì∑</span><br><br>
              <strong>Click & Paste (Ctrl+V)</strong><br>
              <span style="color:var(--text-dim);font-size:12px;">Screenshot of Cut List</span>
            </div>
            
            <div class="preview-wrap" id="previewWrap">
              <img id="previewImg" class="preview-img">
              <div style="display:flex;gap:8px;justify-content:center;">
                <button class="btn btn-primary btn-sm" id="autoReadBtn" onclick="runGemini()">‚ö° Auto-Read Table</button>
                <button class="btn btn-secondary btn-sm" onclick="clearImage()">Clear</button>
              </div>
              <div class="ocr-bar" id="ocrBar"><div class="ocr-fill" id="ocrFill"></div></div>
              <div id="ocrStatus" style="font-size:11px;color:var(--text-dim);margin-top:8px;"></div>
            </div>
          </div>
          
        </div>
      </div>

      <div class="col-right">
        <div class="card">
          <div class="card-label">3. Verify Data</div>
          <div style="height:350px;overflow-y:auto;border:1px solid var(--border);margin-bottom:12px;">
            <table class="ss-table">
              <thead>
                <tr>
                  <th style="width:40px;text-align:center;">#</th>
                  <th>Label</th>
                  <th style="width:70px">Qty</th>
                  <th>Length/Note</th>
                </tr>
              </thead>
              <tbody id="ssBody"></tbody>
            </table>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <button class="btn btn-secondary btn-sm" onclick="ssAddRow()">+ Add Row</button>
            <span id="ssStatus" style="font-size:12px;color:var(--text-dim);">0 labels</span>
          </div>
        </div>
      </div>
      
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goStep(1)">‚Üê Back</button>
      <button class="btn btn-primary" onclick="goStep(3)">Review & Print ‚Üí</button>
    </div>
  </div>

  <div class="panel" id="panel-3">
    <div class="card">
      <div class="card-label">Review Summary</div>
      <div id="reviewContent" style="padding:20px;text-align:center;color:var(--text-dim);">
        </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="goStep(2)">‚Üê Edit Data</button>
      <button class="btn btn-primary" onclick="goStep(4)">Confirm ‚Üí</button>
    </div>
  </div>

  <div class="panel" id="panel-4">
    <div class="card" style="text-align:center;padding:60px 20px;">
      <div style="font-size:48px;margin-bottom:16px;">üìÑ</div>
      <h2>Ready to Print</h2>
      <p style="color:var(--text-dim);margin-bottom:32px;">The PDF labels are ready for generation.</p>
      
      <div style="display:flex;gap:12px;justify-content:center;">
        <button class="btn btn-primary" onclick="downloadPDF()">Download PDF</button>
      </div>
      
      <div style="margin-top:40px;border-top:1px solid var(--border);padding-top:20px;">
        <button class="btn btn-secondary btn-sm" onclick="location.reload()">Start New Panel</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIGURATION
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê 
*/
const GEMINI_API_KEY = 'AIzaSyChGyqASsJs5lAPvFUDTpURFBQnVKgsgFw'; // User Provided Key
const APP_PASSCODE = '1234'; 

// STATE
let projectList = ["UNLV - Lynn Bennett", "Project B"];
let ssData = []; // {label, qty, note}
let capturedImage = null; // Base64

// ‚îÄ‚îÄ LOCK LOGIC ‚îÄ‚îÄ
function checkPass(input) {
  if(input.value === APP_PASSCODE) {
    document.getElementById('lockScreen').style.opacity = '0';
    setTimeout(() => {
      document.getElementById('lockScreen').style.display = 'none';
      document.getElementById('appShell').style.display = 'block';
    }, 300);
    ssInit();
    loadProjects();
  } else if (input.value.length >= 4) {
    document.getElementById('lockMsg').textContent = 'Incorrect Code';
    input.style.borderColor = 'var(--danger)';
    setTimeout(()=> {
      document.getElementById('lockMsg').textContent='';
      input.value='';
      input.style.borderColor = 'var(--border)';
    }, 1500);
  }
}

// ‚îÄ‚îÄ NAV LOGIC ‚îÄ‚îÄ
function goStep(n) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('visible'));
  document.getElementById('panel-'+n).classList.add('visible');
  document.querySelectorAll('.step-pill').forEach(p => {
    p.classList.remove('active');
    if(p.dataset.step == n) p.classList.add('active');
  });
  if(n===3) renderReview();
}

// ‚îÄ‚îÄ IMAGE LOGIC ‚îÄ‚îÄ
document.getElementById('pasteZone').addEventListener('paste', handlePaste);
document.addEventListener('paste', (e) => {
  if(document.getElementById('panel-2').classList.contains('visible') && !document.querySelector('input:focus')) {
    handlePaste(e);
  }
});

function handlePaste(e) {
  const items = (e.clipboardData || e.originalEvent.clipboardData).items;
  for (const item of items) {
    if (item.type.indexOf('image') !== -1) {
      e.preventDefault();
      const blob = item.getAsFile();
      const reader = new FileReader();
      reader.onload = (event) => {
        capturedImage = event.target.result;
        document.getElementById('previewImg').src = capturedImage;
        document.getElementById('pastePrompt').style.display = 'none';
        document.getElementById('previewWrap').style.display = 'block';
      };
      reader.readAsDataURL(blob);
    }
  }
}

function clearImage() {
  capturedImage = null;
  document.getElementById('previewWrap').style.display = 'none';
  document.getElementById('pastePrompt').style.display = 'block';
  document.getElementById('ocrStatus').innerHTML = '';
  document.getElementById('ocrFill').style.width = '0%';
}

// ‚îÄ‚îÄ GEMINI API LOGIC ‚îÄ‚îÄ
async function runGemini() {
  if(!capturedImage) return toast("No image pasted!");
  
  const btn = document.getElementById('autoReadBtn');
  const bar = document.getElementById('ocrFill');
  const status = document.getElementById('ocrStatus');
  
  btn.disabled = true;
  document.querySelector('.ocr-bar').style.display = 'block';
  bar.style.width = '10%';
  status.textContent = "Uploading to Gemini Vision...";

  try {
    const base64 = capturedImage.split(',')[1];
    
    // Using gemini-1.5-flash for speed/stability
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { inline_data: { mime_type: "image/png", data: base64 } },
            { text: "Analyze this construction cut list image. Return a JSON object with this structure: { panel_id: 'string (if found)', items: [ { label: 'string', qty: number, note: 'string' } ] }. RULES: 1. Extract the 'Label' (e.g. C1, T4), 'Qty' (Quantity), and 'Length' (put length in the note field). 2. IMPORTANT: If a row has a RED LINE strikethrough, EXCLUDE IT completely. 3. If there is handwritten red text correcting a number, use the handwritten value." }
          ]
        }]
      })
    });

    bar.style.width = '60%';
    status.textContent = "Processing response...";
    
    if(!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || "API Error");
    }
    
    const data = await response.json();
    const rawText = data.candidates[0].content.parts[0].text;
    const jsonMatch = rawText.match(/\{[\s\S]*\}/);
    if(!jsonMatch) throw new Error("No JSON found in response");
    
    const result = JSON.parse(jsonMatch[0]);

    if(result.panel_id) document.getElementById('panelId').value = result.panel_id;
    
    // Merge results
    const newItems = result.items.map(i => ({
      label: i.label ? i.label.toUpperCase() : '',
      qty: parseInt(i.qty) || 1,
      note: i.note || ''
    }));
    
    ssData = [...newItems];
    // Ensure min rows
    while(ssData.length < 8) ssData.push({label:'',qty:1,note:''});
    
    renderGrid();
    
    bar.style.width = '100%';
    status.textContent = `Done! Extracted ${newItems.length} items.`;
    toast("Table extracted successfully!");

  } catch(e) {
    bar.style.backgroundColor = 'var(--danger)';
    status.textContent = "Error: " + e.message;
    console.error(e);
  }
  btn.disabled = false;
}

// ‚îÄ‚îÄ GRID LOGIC ‚îÄ‚îÄ
function ssInit() {
  ssData = Array(10).fill().map(()=>({label:'',qty:1,note:''}));
  renderGrid();
}
function renderGrid() {
  const tbody = document.getElementById('ssBody');
  tbody.innerHTML = '';
  ssData.forEach((row, i) => {
    tbody.innerHTML += `
      <tr>
        <td style="color:var(--text-dim);text-align:center;">${i+1}</td>
        <td><input class="ss-cell-input" value="${row.label}" oninput="updateRow(${i}, 'label', this.value)" placeholder="Label"></td>
        <td><input type="number" class="ss-cell-input" value="${row.qty}" oninput="updateRow(${i}, 'qty', this.value)"></td>
        <td><input class="ss-cell-input" value="${row.note}" oninput="updateRow(${i}, 'note', this.value)" placeholder="Length"></td>
      </tr>`;
  });
  updateStatus();
}
function updateRow(i, field, val) {
  ssData[i][field] = val;
  updateStatus();
}
function ssAddRow() {
  ssData.push({label:'', qty:1, note:''});
  renderGrid();
}
function updateStatus() {
  const count = ssData.filter(r => r.label).length;
  document.getElementById('ssStatus').textContent = `${count} active labels`;
}

// ‚îÄ‚îÄ REVIEW & PDF ‚îÄ‚îÄ
function renderReview() {
  const pid = document.getElementById('panelId').value || "Unknown Panel";
  const valid = ssData.filter(r => r.label);
  const total = valid.reduce((acc, r) => acc + parseInt(r.qty||0), 0);
  
  document.getElementById('reviewContent').innerHTML = `
    <h3>${pid}</h3>
    <div style="font-size:40px;font-weight:700;margin:16px 0;">${total}</div>
    <p>Total Labels to Print</p>
    <div style="margin-top:20px;font-family:var(--mono);font-size:12px;text-align:left;display:inline-block;">
      ${valid.map(r => `<div>${r.label} x ${r.qty} <span style="color:var(--text-dim)">(${r.note})</span></div>`).join('')}
    </div>
  `;
}

async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: [100, 150] }); // Custom label size example
  // Standard A4 for cut sheets
  // const doc = new jsPDF(); 
  
  const valid = ssData.filter(r => r.label);
  const pid = document.getElementById('panelId').value || "PANEL";
  
  let x = 10, y = 10;
  
  // Simple layout logic for example (A4 Sheet logic)
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text(`Panel: ${pid}`, 10, 10);
  
  let yPos = 20;
  valid.forEach(row => {
    for(let i=0; i<row.qty; i++) {
      if(yPos > 270) { doc.addPage(); yPos = 20; }
      
      // Draw Label
      doc.setDrawColor(0);
      doc.rect(10, yPos, 90, 25);
      
      doc.setFontSize(24);
      doc.text(row.label, 15, yPos+12);
      
      doc.setFontSize(10);
      doc.text(`Panel: ${pid}`, 15, yPos+20);
      doc.text(`Len: ${row.note}`, 60, yPos+20);
      
      yPos += 30;
    }
  });

  doc.save(`${pid}_labels.pdf`);
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
}
function loadProjects() {
  const sel = document.getElementById('projectSelect');
  sel.innerHTML = '<option value="">‚Äî Select ‚Äî</option>';
  projectList.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p; opt.textContent = p;
    sel.appendChild(opt);
  });
}
function addProject() {
  const val = document.getElementById('newProjectInput').value;
  if(val) {
    projectList.push(val);
    loadProjects();
    document.getElementById('projectSelect').value = val;
    document.getElementById('newProjectInput').value = '';
  }
}
</script>
</body>
</html>